name: Release

on:
  push:
    tags:
      # ä»…å½“ git push ä¸€ä¸ªå½¢å¦‚ 1.0.0 çš„ tag æ—¶è§¦å‘
      # åŒ¹é…ç±»ä¼¼ 1.0.0ã€2.3.4 è¿™æ ·çš„ tag
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆ changelog

      # ğŸŒ è®¾ç½® Node.js å¹¶æ„å»ºå‰ç«¯
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'
          cache-dependency-path: elysiananime-ui/yarn.lock

      - name: Install and Build Frontend
        run: |
          cd elysiananime-ui
          yarn install --frozen-lockfile
          yarn build
        env:
          VITE_API_URL: "/api"  # å‰ç«¯è°ƒç”¨åç«¯ API çš„è·¯å¾„

      # â˜• è®¾ç½® Java å¹¶æ„å»ºåç«¯
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build Backend with Maven
        run: |
          cd elysiananime-server
          mvn -B package -DskipTests

      # ğŸ“¦ åˆ›å»º release ç›®å½•å¹¶åˆå¹¶æ–‡ä»¶
      - name: Prepare Release Directory
        run: |
          mkdir -p ElysianAnime-Release/{backend,frontend}
          
          # å¤åˆ¶åç«¯ jar
          cp elysiananime-server/elysiananime-api/target/*.jar ElysianAnime-Release/backend/
          cp elysiananime-server/elysiananime-api/target/classes/app.yml ElysianAnime-Release/backend/
          
          # å¤åˆ¶å‰ç«¯æ„å»ºç»“æœ
          cp -r elysiananime-ui/dist/* ElysianAnime-Release/frontend/
          
          # å¤åˆ¶å¯åŠ¨è„šæœ¬
          cp doc/bin/start.bat ElysianAnime-Release/backend/
          cp doc/bin/stop.bat ElysianAnime-Release/backend/
          cp doc/bin/start.sh ElysianAnime-Release/backend/

          # å¯é€‰ï¼šå¤åˆ¶ README æˆ–è¯´æ˜æ–‡ä»¶
          cp README.md ElysianAnime-Release/ || echo "No README.md"

      # ğŸ—œï¸ æ‰“åŒ…ä¸º ZIP
      - name: Create ZIP Archive
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          zip -r "ElysianAnime-$VERSION.zip" ElysianAnime-Release/
        id: zip

      # ğŸ“œ ç”Ÿæˆ changelog
      - name: Build Changelog
        id: github_release
        uses: mikepenz/release-changelog-builder-action@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "categories": [
                {
                    "title": "## ğŸš€ Features",
                    "labels": ["feature", "feat"]
                },
                {
                    "title": "## ğŸ› Fixes",
                    "labels": ["fix", "bug"]
                },
                {
                    "title": "## ğŸ§ª Tests",
                    "labels": ["test"]
                },
                {
                    "title": "## ğŸ’¬ Other",
                    "labels": ["other"]
                },
                {
                    "title": "## ğŸ“¦ Dependencies",
                    "labels": ["dependencies"]
                }
              ]
            }
          fail_on_error: false  # é¿å…å› æ—  PR å¯¼è‡´å¤±è´¥

      # ğŸš€ åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref }}
          name: "${{ github.ref_name }}"
          body: ${{ steps.github_release.outputs.changelog }}
          draft: false
          prerelease: false
          files: |
            ElysianAnime-*.zip
